<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carteira — Kalebi SDC</title>
  <meta name="description" content="Gerencie seu saldo e solicite saques com segurança">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#3a66c7;
      --primary-dark:#08306b;
      --bg-top:#e8f3ff;
      --bg-bottom:#e2ecff;
      --card:#ffffff;
      --muted:#32486b;
      --border:#dce7ff;
      --success:#0a9d58;
      --accent:#2b5be0;
      --radius:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Poppins, Inter, Arial, Helvetica, sans-serif;background:linear-gradient(180deg,var(--bg-top) 0%,var(--bg-bottom) 100%);color:#111}
    body{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:12px}

    .container{max-width:420px;width:100%;display:flex;align-items:center;justify-content:center}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(10,40,100,0.12);overflow:hidden;width:100%;max-width:420px}

    header{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:#fff;padding:18px;text-align:center}
    .top-name{margin:0;font-size:13px;font-weight:600;opacity:0.95}
    header h1{margin:6px 0 0;font-size:16px;font-weight:700}
    header p{margin:8px 0 0;font-size:12px;opacity:0.95}
    .benefits{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;justify-content:center}
    .chip{background:rgba(255,255,255,0.12);padding:5px 8px;border-radius:999px;font-size:11px;color:#fff}

    .content{padding:18px}
    .section-title{font-size:12px;color:var(--muted);margin:8px 0}

    .input-group{display:flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px;border-radius:10px;background:linear-gradient(180deg,rgba(150,120,255,0.03),transparent)}
    .input-prefix{color:var(--primary);font-weight:700}
    input,select{border:0;outline:0;font-size:14px;width:100%;background:transparent}

    .confirm{width:100%;padding:12px;border-radius:10px;background:var(--accent);color:#fff;border:0;font-weight:700;cursor:pointer;transition:background .18s,transform .08s}
    .confirm:hover{background:var(--primary-dark);transform:translateY(-1px)}
    .confirm[disabled]{opacity:0.6;cursor:default;transform:none}

    .policy{font-size:13px;color:var(--muted);margin-top:10px;line-height:1.45}
    .log-box{max-height:220px;overflow:auto;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(0,0,0,0.01),transparent);border:1px solid var(--border);margin-top:10px}
    .log-item{padding:8px;border-bottom:1px dashed rgba(0,0,0,0.05);font-size:13px}

    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center}
    .modal{background:#fff;padding:20px;border-radius:12px;max-width:320px;text-align:center}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;background:#2b2340;color:#fff;padding:8px 12px;border-radius:8px;display:none;font-size:13px}

    @media (max-width:420px){.card{max-width:95vw}.top-name{font-size:12px}header h1{font-size:15px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card" role="main">
      <header>
        <p class="top-name">Kalebi SDC Capital</p>
        <h1>Minha Carteira</h1>
        <p class="hero-sub">Gerencie seu saldo, solicite saques e acompanhe o histórico.</p>
        <div class="benefits">
          <div class="chip">Taxa transparente</div>
          <div class="chip">Processamento rápido</div>
          <div class="chip">Suporte ativo</div>
        </div>
      </header>

      <div class="content">
        <label class="section-title">Saldo disponível</label>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="font-size:20px;font-weight:700">R$ <span id="saldo">0,00</span></div>
        </div>

        <!-- Campo de depósito removido conforme solicitado -->

        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">

        <h3 class="section-title">Solicitar Saque</h3>
        <form id="formSaque">
          <label class="section-title" for="valor">Valor do Saque</label>
          <div class="input-group">
            <div class="input-prefix">R$</div>
            <input id="valor" inputmode="decimal" placeholder="Ex: 100,00">
          </div>

          <label class="section-title" for="nome">Nome completo</label>
          <input id="nome" placeholder="Seu nome completo">

          <label class="section-title" for="tipoPix">Tipo de chave Pix</label>
          <select id="tipoPix">
            <option value="cpf">CPF</option>
            <option value="email">E-mail</option>
            <option value="telefone">Telefone</option>
          </select>

          <label class="section-title" for="chave">Chave Pix</label>
          <input id="chave" placeholder="Digite a chave Pix">

          <div style="margin-top:12px;display:flex;gap:10px">
            <button type="submit" class="confirm">Confirmar saque</button>
          </div>
        </form>

        <div class="policy">
          <strong>Política de Saques</strong><br>
          Valor mínimo: R$ 30,00 · Taxa: 6% · Limite: 1 saque/dia · Horário: 10h–17h · Processamento: até 24h
        </div>

        <h3 class="section-title" style="margin-top:14px">Histórico de saques</h3>
        <div id="historico" class="log-box">Nenhum saque realizado.</div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal" id="modal">
      <div id="modal-content">Processando saque…</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script src="app.js"></script>
  <script>
    (function(){
      const elSaldo = document.getElementById('saldo');
      const form = document.getElementById('formSaque');
      const historico = document.getElementById('historico');
      const overlay = document.getElementById('overlay');
      const modalContent = document.getElementById('modal-content');
      const toast = document.getElementById('toast');

      // --- implementações locais de carteira (fallback para localStorage) ---
      function _parseNumber(v){
        if(v==null) return 0;
        if(typeof v === 'number') return v;
        const s = String(v).replace(/[\.\s]/g,'').replace(/,/g,'.');
        const n = parseFloat(s);
        return isNaN(n)? 0 : n;
      }

      function getBalance(){
        // procura por chaves comuns
        const keys = ['saldo','carteira_saldo','carteiraSaldo','carteira','balance','vast_saldo'];
        for(const k of keys){
          const v = localStorage.getItem(k);
          if(v==null) continue;
          try{ const parsed = JSON.parse(v); if(parsed && typeof parsed === 'object' && typeof parsed.saldo !== 'undefined') return _parseNumber(parsed.saldo); }catch(e){}
          const n = _parseNumber(v);
          if(n !== 0) return n;
        }
        return 0;
      }

      function setBalance(newBalance){
        const v = Number(Number(newBalance).toFixed(2));
        // prefira chave `saldo`
        localStorage.setItem('saldo', String(v));
        // notifica listeners
        if(typeof window._walletUpdateCb === 'function') try{ window._walletUpdateCb(); }catch(e){}
      }

      function getTransactions(){
        try{ return JSON.parse(localStorage.getItem('wallet_transactions')||'[]'); }catch(e){ return []; }
      }

      function addTransaction(amount, description){
        const txs = getTransactions();
        const tx = { amount: Number(amount), description: description||'', date: new Date().toISOString(), timestamp: Date.now() };
        txs.push(tx);
        localStorage.setItem('wallet_transactions', JSON.stringify(txs));
        // atualiza saldo (amount positivo = depósito; negativo = saque)
        const bal = getBalance();
        setBalance(Number((bal + Number(amount)).toFixed(2)));
        if(typeof window._walletUpdateCb === 'function') try{ window._walletUpdateCb(); }catch(e){}
      }

      function onWalletUpdate(cb){ window._walletUpdateCb = cb; }
      window.getBalance = window.getBalance || getBalance;
      window.getTransactions = window.getTransactions || getTransactions;
      window.addTransaction = window.addTransaction || addTransaction;
      window.onWalletUpdate = window.onWalletUpdate || onWalletUpdate;
      // --------------------------------------------------------------------

      function formatBRL(v){
        return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
      }
      function showToast(msg, ms=3000){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=> toast.style.display='none', ms); }

      async function updateUI(){
        try{
          let balance = 0;
          let txs = [];
          if(window.API_BASE && window.walletApi){
            const res = await walletApi.getWallet();
            balance = (res && res.balance) ? res.balance : 0;
            txs = (res && res.transactions) ? res.transactions : [];
          } else {
            balance = (typeof getBalance === 'function') ? getBalance() : 0;
            txs = (typeof getTransactions === 'function') ? getTransactions() : [];
          }
          elSaldo.textContent = formatBRL(balance);
          renderTransactions(txs);
        }catch(err){
          console.error('Erro ao atualizar UI', err);
        }
      }

      function renderTransactions(txs){
        if(!txs || txs.length === 0){
          historico.textContent = 'Nenhum saque realizado.';
          return;
        }
        historico.innerHTML = '';
        // show newest first
        txs.slice().reverse().forEach(t=>{
          const item = document.createElement('div'); item.className='log-item';
          const when = new Date(t.date || t.timestamp || Date.now());
          const kind = (t.amount >= 0) ? 'Depósito' : 'Saque/Compra';
          const desc = t.description || kind;
          item.innerHTML = `<strong>${formatBRL(Math.abs(t.amount))}</strong> • ${desc} <br><small style="color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')}">${when.toLocaleString()}</small>`;
          historico.appendChild(item);
        });
      }

      function parseValor(text){
        if(!text) return NaN;
        const n = text.replace(/[.\s]/g,'').replace(/,/g,'.');
        return parseFloat(n);
      }

      form.addEventListener('submit', function(e){
        e.preventDefault();
        const raw = document.getElementById('valor').value.trim();
        const valor = parseValor(raw);
        const nome = document.getElementById('nome').value.trim();
        const tipoPix = document.getElementById('tipoPix').value;
        const chave = document.getElementById('chave').value.trim();

        if(!nome || !chave || isNaN(valor)){
          showToast('Preencha corretamente todos os campos.');
          return;
        }
        if(valor < 30){ showToast('O valor mínimo para saque é R$ 30,00'); return; }

        const taxa = Math.round(valor * 0.06 * 100)/100;
        const totalDebitar = Math.round((valor + taxa) * 100)/100;

        // check current balance
        const current = (typeof getBalance === 'function') ? getBalance() : null;
        if(current !== null && totalDebitar > current){ showToast('Saldo insuficiente. Saldo atual: ' + formatBRL(current)); return; }

        // Simula processamento
        overlay.style.display = 'flex';
        modalContent.textContent = 'Processando saque de ' + formatBRL(valor) + '…';

        setTimeout(()=>{
          overlay.style.display = 'none';
          // register withdrawal as a negative transaction
          const desc = `Saque: ${nome} (${tipoPix})`;
          if(typeof addTransaction === 'function'){
            addTransaction(-totalDebitar, desc);
          }
          showToast('✅ Saque solicitado com sucesso');
          form.reset();
          updateUI();
        },1200);
      });

      // Handler de depósito removido

      // respond to updates from other pages/tabs
      if(typeof onWalletUpdate === 'function') onWalletUpdate(()=> updateUI());
      // initial render
      updateUI();
    })();
  </script>
</body>
</html>
